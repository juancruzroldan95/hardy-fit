---
import Layout from "../layouts/Layout.astro";
import SectionContainer from "../components/SectionContainer.astro";
import LocationCard from "../components/LocationCard.astro";
import { LOCATIONS } from "../consts/locations";
import "mapbox-gl/dist/mapbox-gl.css";

const MAPBOX_TOKEN =
  "pk.eyJ1IjoianVhbmNydXpyb2xkYW45NSIsImEiOiJjbWl3N2U0Y2QxaWx5M2dxMHFpbThsYW96In0.M2DLrjIYdH0h8xIXmaLHdg";
const MAPBOX_STYLE_URL =
  "mapbox://styles/juancruzroldan95/cmj0qyq7y001201s2h3iydsul";
const MAP_CENTER = [-58.3816, -34.6037];
const MAP_ZOOM = 9;

// Filter active locations
const activeLocations = LOCATIONS.filter((loc) => loc.isActive !== false);

// Extract unique states from active locations
const STATES = [...new Set(activeLocations.map((loc) => loc.state))].sort();
---

<Layout
  title="Puntos de venta - HARDY"
  description="Encontrá los puntos de venta donde podés conseguir nuestros productos. Usá el listado o navega en el mapa."
>
  <main class="pt-16">
    <!-- Hero -->
    <SectionContainer
      id="hero"
      class="relative py-16 overflow-hidden"
      noContainer={true}
    >
      <div class="absolute inset-0 bg-cream"></div>
      <div
        class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,rgba(195,33,54,0.12),transparent_55%)]"
      >
      </div>
      <div
        class="relative max-w-5xl mx-auto px-6 lg:px-8 text-center scrolling-section opacity-0"
      >
        <h1
          class="text-4xl md:text-6xl font-header font-extrabold text-primary uppercase mb-4"
        >
          Puntos de venta HARDY
        </h1>
        <p
          class="text-lg md:text-xl text-neutral-700 leading-relaxed max-w-3xl mx-auto"
        >
          Localizá los puntos de venta donde podés conseguir nuestros productos.
          Usá el listado o navega en el mapa para encontrar la tienda más
          cercana.
        </p>
      </div>
    </SectionContainer>

    <!-- Locations + Map -->
    <SectionContainer id="locations" class="py-12 bg-white">
      <div class="flex flex-col-reverse lg:flex-row gap-6 lg:gap-8">
        <div
          class="locations-list w-full lg:w-1/3 bg-white rounded-2xl shadow-lg ring-1 ring-neutral-200 p-4 md:p-6 flex flex-col gap-4 max-h-none lg:max-h-[80vh] overflow-visible lg:overflow-y-auto scrolling-section opacity-0"
          data-locations-json={JSON.stringify(activeLocations)}
        >
          <div class="locations-header space-y-1">
            <h2
              class="text-2xl font-header font-extrabold text-primary uppercase"
            >
              Puntos de venta
            </h2>
            <p class="text-sm text-neutral-600">
              Hacé clic en un punto de venta para centrarlo en el mapa.
            </p>
          </div>

          <!-- State Filter Buttons -->
          <div
            class="state-filters flex flex-wrap gap-2 pb-2 border-b border-neutral-200"
          >
            {
              STATES.map((state) => (
                <button
                  type="button"
                  class="state-filter-btn px-3 py-1.5 text-sm font-medium rounded-lg transition-colors bg-neutral-100 text-neutral-700 hover:bg-neutral-200"
                  data-state={state}
                >
                  {state}
                </button>
              ))
            }
          </div>

          <div class="locations-grid grid grid-cols-1 gap-3">
            {
              activeLocations.map((loc, idx) => (
                <LocationCard
                  id={`loc-${idx}`}
                  storeName={loc.storeName}
                  address={loc.address}
                  city={loc.city}
                  state={loc.state}
                  postalCode={loc.postalCode}
                  country={loc.country}
                />
              ))
            }
          </div>
        </div>

        <div
          id="map"
          class="map-container relative w-full lg:flex-1 h-[60vh] md:h-[70vh] lg:h-[80vh] rounded-2xl shadow-xl scrolling-section opacity-0 scroll-mt-24 focus:outline-none focus:ring-0 overflow-visible"
          data-token={MAPBOX_TOKEN ?? ""}
          data-style={MAPBOX_STYLE_URL}
          data-center={JSON.stringify(MAP_CENTER)}
          data-zoom={MAP_ZOOM}
        >
        </div>
      </div>
    </SectionContainer>
  </main>

  <script src="../scripts/mapbox-scriipt.js"></script>

  <script is:inline>
    // State filter functionality
    document.addEventListener("DOMContentLoaded", () => {
      let activeState = null;
      const filterButtons = document.querySelectorAll(".state-filter-btn");
      const locationCards = document.querySelectorAll(".location-card");

      filterButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const state = button.dataset.state;

          if (!state) return;

          // If clicking the same button, remove filter
          if (activeState === state) {
            activeState = null;
            button.classList.remove("bg-primary", "text-white");
            button.classList.add("bg-neutral-100", "text-neutral-700");

            // Show all cards
            locationCards.forEach((card) => {
              card.style.display = "";
            });
          } else {
            // Remove active state from all buttons
            filterButtons.forEach((btn) => {
              btn.classList.remove("bg-primary", "text-white");
              btn.classList.add("bg-neutral-100", "text-neutral-700");
            });

            // Set new active state
            activeState = state;
            button.classList.remove("bg-neutral-100", "text-neutral-700");
            button.classList.add("bg-primary", "text-white");

            // Filter cards
            locationCards.forEach((card) => {
              if (card.dataset.state === state) {
                card.style.display = "";
              } else {
                card.style.display = "none";
              }
            });
          }
        });
      });
    });
  </script>

  <script>
    import { animate, stagger, inView } from "motion";

    const isMobile = window.innerWidth < 768;
    const threshold = isMobile ? 0.1 : 0.2;

    inView(
      ".scrolling-section",
      (element) => {
        animate(
          element,
          { opacity: [0, 1], y: [50, 0] },
          { ease: [0.39, 0.24, 0.3, 1], duration: 1 },
        );

        const cards = element.querySelectorAll(".card, .location-card");
        if (cards.length > 0) {
          animate(
            cards,
            { opacity: [0, 1], y: [25, 0] },
            { type: "spring", delay: stagger(0.2, { startDelay: 0.25 }) },
          );
        }
      },
      { amount: threshold },
    );
  </script>
</Layout>
